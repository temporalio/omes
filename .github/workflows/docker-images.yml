name: Build docker images

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      push-command:
        description: Push command to run (e.g., 'build-push-worker-image' or 'build-push-cli-image')
        type: string
        default: "build-push-worker-image"
      lang:
        description: SDK language to build the container for (only for worker images)
        required: false
        type: string
      sdk-repo-ref:
        description: Git ref of SDK repo to use to build (overrides "sdk-version")
        required: false
        type: string
      sdk-repo-url:
        description: URL of SDK repo to use to build (only used if "sdk-repo-ref" is provided)
        required: false
        type: string
      sdk-version:
        description: Version of SDK to use (ignored if "sdk-repo-ref" is provided, not used for CLI images)
        required: false
        type: string
      docker-tag-ext:
        description: Tag extension to use for the built image (only when using sdk-repo-ref)
        required: false
        type: string
      do-push:
        description: If set, push the built image to Docker Hub.
        type: boolean
        default: false
      as-latest:
        description: If set, tag the images as latest for the lang ('<lang>-latest').
        type: boolean
        default: false
      omes-repo-path:
        type: string
        default: "temporalio/omes"
      omes-repo-ref:
        type: string

jobs:
  # Stage 1: Build each platform in parallel
  build-single-platform:
    name: Build ${{ inputs.lang || 'CLI' }} (${{ matrix.platform-name }})
    runs-on: ubuntu-latest
    if: inputs.do-push && !github.event.pull_request.head.repo.fork
    timeout-minutes: 30
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
        include:
          - platform: linux/amd64
            platform-name: amd64
          - platform: linux/arm64
            platform-name: arm64
    steps:
      - name: Checkout omes repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.omes-repo-path }}
          ref: ${{ inputs.omes-repo-ref || github.head_ref }}
          submodules: true
          fetch-depth: 0

      - name: Checkout lang repo
        if: ${{ inputs.sdk-repo-ref }}
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.sdk-repo-url }}
          submodules: recursive
          path: checked-out-sdk/
          ref: ${{ inputs.sdk-repo-ref }}
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Expose cache mounts for buildkit
        uses: reproducible-containers/buildkit-cache-dance@v3
        with:
          cache-map: |
            {
              "go-pkg": "/go/pkg/mod",
              "go-build-${{ matrix.platform-name }}": "/root/.cache/go-build",
              "cargo-registry": "/root/.cargo/registry",
              "cargo-git": "/root/.cargo/git",
              "uv-cache": "/root/.cache/uv",
              "npm-cache-${{ matrix.platform-name }}": "/root/.npm",
              "gradle-cache-${{ matrix.platform-name }}": "/gradle-cache",
              "nuget-cache-${{ matrix.platform-name }}": "/root/.nuget/packages"
            }
          skip-extraction: ${{ steps.cache.outputs.cache-hit }}

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PAT }}

      - name: Build and push single platform
        env:
          LANG: ${{ inputs.lang }}
          SDK_VERSION: ${{ inputs.sdk-version || 'checked-out-sdk/' }}
          LANG_ARGS: ${{ inputs.lang && format('--language {0}', inputs.lang) || '' }}
          VERSION_ARGS: ${{ inputs.sdk-version && format('--version {0}', inputs.sdk-version) || '' }}
          PUSH_COMMAND: ${{ inputs.push-command }}
          TEMP_TAG: ${{ inputs.lang || 'cli' }}-temp-${{ github.run_id }}-${{ matrix.platform-name }}
        run: |
          go run ./cmd/dev "$PUSH_COMMAND" \
          --platform ${{ matrix.platform }} \
          --repo-prefix temporaliotest \
          --image-tag "$TEMP_TAG" \
          --force-push \
          $LANG_ARGS \
          $VERSION_ARGS

  # Stage 2: Create multi-arch manifest and apply final tags
  create-manifest:
    name: Create manifest for ${{ inputs.lang || 'CLI' }}
    runs-on: ubuntu-latest
    needs: build-single-platform
    if: inputs.do-push && !github.event.pull_request.head.repo.fork
    steps:
      - name: Checkout omes repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.omes-repo-path }}
          ref: ${{ inputs.omes-repo-ref || github.head_ref }}
          submodules: true
          fetch-depth: 0

      - name: Checkout lang repo
        if: ${{ inputs.sdk-repo-ref }}
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.sdk-repo-url }}
          submodules: recursive
          path: checked-out-sdk/
          ref: ${{ inputs.sdk-repo-ref }}
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PAT }}

      - name: Generate final tags and create manifests
        env:
          LANG: ${{ inputs.lang }}
          SDK_VERSION: ${{ inputs.sdk-version || 'checked-out-sdk/' }}
          IMAGE_TAG_ARGS: ${{ inputs.sdk-repo-ref && format('--image-tag {0}-{1}', inputs.lang, inputs.docker-tag-ext) || ''}}
          TAG_LATEST_ARGS: ${{ inputs.as-latest && '--tag-as-latest' || ''}}
          LANG_ARGS: ${{ inputs.lang && format('--language {0}', inputs.lang) || '' }}
          VERSION_ARGS: ${{ inputs.sdk-version && format('--version {0}', inputs.sdk-version) || '' }}
          PUSH_COMMAND: ${{ inputs.push-command }}
          LANG_OR_CLI: ${{ inputs.lang || 'cli' }}
        run: |
          # Run build command with --dry-run to get the final tags
          go run ./cmd/dev "$PUSH_COMMAND" \
            --platform linux/amd64,linux/arm64 \
            --repo-prefix temporaliotest \
            --dry-run \
            $LANG_ARGS \
            $VERSION_ARGS \
            $IMAGE_TAG_ARGS \
            $TAG_LATEST_ARGS

          # Get the tags from GitHub env
          FINAL_TAGS="${BUILT_IMAGE_TAGS}"

          # Split tags by semicolon
          IFS=';' read -ra TAG_ARRAY <<< "$FINAL_TAGS"

          # Create and push manifest for each final tag
          for final_tag in "${TAG_ARRAY[@]}"; do
            echo "Creating manifest for $final_tag"
            docker manifest create "$final_tag" \
              "temporaliotest/omes:${LANG_OR_CLI}-temp-${{ github.run_id }}-amd64" \
              "temporaliotest/omes:${LANG_OR_CLI}-temp-${{ github.run_id }}-arm64"
            docker manifest push "$final_tag"
          done

      - name: ðŸ³ Docker Hub image tag
        env:
          LANG: ${{ inputs.lang || 'CLI' }}
        run: |
          echo "::notice title=ðŸ³ Docker Hub image published for $LANG::Check temporaliotest/omes tags"
