name: Continuous Integration

env:
  MISE_VERSION: v2025.8.1

on: # rebuild any PRs and main branch changes
  pull_request:
  push:
    branches:
      - main

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Run shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          format: gcc
          severity: error

  build-lint-test-go:
    runs-on: ubuntu-latest
    steps:
      - name: Print build information
        run: "echo head_ref: ${{ github.head_ref }}, ref: ${{ github.ref }}"
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Install mise
        uses: jdx/mise-action@v2.4.4
        with:
          version: ${{ env.MISE_VERSION }}
      - name: Install Go
        run: ./scripts/install-go.sh
      - name: Lint Go
        run: |
          ./scripts/lint-go-worker.sh
      - name: Check Go formatting
        run: |
          git diff --exit-code || (echo "Go worker has uncommitted formatting changes after linting" && exit 1)
      - name: Build Go worker
        run: |
          ./scripts/build-go-worker.sh

  build-lint-test-java:
    runs-on: ubuntu-latest
    steps:
      - name: Print build information
        run: "echo head_ref: ${{ github.head_ref }}, ref: ${{ github.ref }}"
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Install mise
        uses: jdx/mise-action@v2.4.4
        with:
          version: ${{ env.MISE_VERSION }}
      - name: Install Tools
        run: |
          ./scripts/install-java.sh
          ./scripts/install-go.sh
      - name: Lint Java
        run: |
          ./scripts/lint-java-worker.sh
      - name: Check Java formatting
        run: |
          git diff --exit-code || (echo "Java worker has uncommitted formatting changes after linting" && exit 1)
      - name: Build Java worker
        run: |
          ./scripts/build-java-worker.sh

  build-lint-test-python:
    runs-on: ubuntu-latest
    steps:
      - name: Print build information
        run: "echo head_ref: ${{ github.head_ref }}, ref: ${{ github.ref }}"
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Install mise
        uses: jdx/mise-action@v2.4.4
        with:
          version: ${{ env.MISE_VERSION }}
      - name: Install Tools
        run: |
          ./scripts/install-python.sh
          ./scripts/install-go.sh
      - name: Lint Python
        run: |
          ./scripts/lint-python-worker.sh
      - name: Check Python formatting
        run: |
          git diff --exit-code || (echo "Python worker has uncommitted formatting changes after linting" && exit 1)
      - name: Build Python worker
        run: |
          ./scripts/build-python-worker.sh

  build-lint-test-typescript:
    runs-on: ubuntu-latest
    steps:
      - name: Print build information
        run: "echo head_ref: ${{ github.head_ref }}, ref: ${{ github.ref }}"
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: 'true'
      - name: Install mise
        uses: jdx/mise-action@v2.4.4
        with:
          version: ${{ env.MISE_VERSION }}
      - name: Install Tools
        run: |
          ./scripts/install-node.sh
          ./scripts/install-go.sh
      - name: Lint TypeScript
        run: |
          ./scripts/lint-typescript-worker.sh
      - name: Check TypeScript formatting
        run: |
          git diff --exit-code || (echo "TypeScript worker has uncommitted formatting changes after linting" && exit 1)
      - name: Build TypeScript worker
        run: |
          ./scripts/build-typescript-worker.sh

  build-lint-test-dotnet:
    runs-on: ubuntu-latest
    steps:
      - name: Print build information
        run: "echo head_ref: ${{ github.head_ref }}, ref: ${{ github.ref }}"
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: 'true'
      - name: Install mise
        uses: jdx/mise-action@v2.4.4
        with:
          version: ${{ env.MISE_VERSION }}
      - name: Install Tools
        run: |
          ./scripts/install-dotnet.sh
          ./scripts/install-go.sh
      - name: Lint .NET
        run: |
          ./scripts/lint-dotnet-worker.sh
      - name: Check .NET formatting
        run: |
          git diff --exit-code || (echo ".NET worker has uncommitted formatting changes after linting" && exit 1)
      - name: Build .NET worker
        run: |
          ./scripts/build-dotnet-worker.sh

  build-ks-gen-and-ensure-protos-up-to-date:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
        with:
          submodules: 'true'
      - name: Install mise
        uses: jdx/mise-action@v2.4.4
        with:
          version: ${{ env.MISE_VERSION }}
      - name: Install Tools
        run: |
          ./scripts/install-rust.sh
          ./scripts/install-go.sh
          ./scripts/install-protoc.sh
          ./scripts/install-node.sh
      - name: Build proto
        run: |
          ./scripts/build-kitchensink.sh
      - name: Check diff
        run: |
          git config --global core.safecrlf false
          git diff > generator.diff
          git diff --exit-code
      - name: Upload generator diff
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: generator-diff
          path: generator.diff
          if-no-files-found: ignore

  # env cannot be referenced in jobs.<job_id>.with.<with_id>, so we need a job to run before
  # to append a "v" to the version string
  prepare-for-docker-push:
    runs-on: ubuntu-latest
    outputs:
      go-sdk-version: ${{ steps.set-output.outputs.go-sdk-version }}
      ts-sdk-version: ${{ steps.set-output.outputs.ts-sdk-version }}
      java-sdk-version: ${{ steps.set-output.outputs.java-sdk-version }}
      python-sdk-version: ${{ steps.set-output.outputs.python-sdk-version }}
      dotnet-sdk-version: ${{ steps.set-output.outputs.dotnet-sdk-version }}
    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
    - name: Load versions
      run: |
        set -a && source versions.env && set +a
        printenv >> $GITHUB_ENV
    - name: Set output variables to pass to docker YML
      id: set-output
      run: |
        echo "go-sdk-version=v${{ env.GO_SDK_VERSION }}" >> "$GITHUB_OUTPUT"
        echo "ts-sdk-version=v${{ env.TYPESCRIPT_SDK_VERSION }}" >> "$GITHUB_OUTPUT"
        echo "java-sdk-version=v${{ env.JAVA_SDK_VERSION }}" >> "$GITHUB_OUTPUT"
        echo "python-sdk-version=v${{ env.PYTHON_SDK_VERSION }}" >> "$GITHUB_OUTPUT"
        echo "dotnet-sdk-version=v${{ env.DOTNET_SDK_VERSION }}" >> "$GITHUB_OUTPUT"
  push-latest-docker-images:
    needs: prepare-for-docker-push
    uses: ./.github/workflows/all-docker-images.yml
    secrets: inherit
    with:
      # Only images that are built from `main` are tagged as `latest`.
      # This ensures that internal systems can rely on the latest tag to be stable.
      as-latest: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
      do-push: true
      go-version: ${{ needs.prepare-for-docker-push.outputs.go-sdk-version }}
      ts-version: ${{ needs.prepare-for-docker-push.outputs.ts-sdk-version }}
      java-version: ${{ needs.prepare-for-docker-push.outputs.java-sdk-version }}
      py-version: ${{ needs.prepare-for-docker-push.outputs.python-sdk-version }}
      dotnet-version: ${{ needs.prepare-for-docker-push.outputs.dotnet-sdk-version }}
